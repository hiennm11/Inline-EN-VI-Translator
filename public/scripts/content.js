let l=!1;const d={},m="p, h1, h2, h3, h4, h5, h6, span, li, td, th, figcaption, blockquote";function h(){chrome.storage.sync.get("translator_on",t=>{l=t.translator_on||!1})}async function b(t){if(!("LanguageDetector"in self))throw new Error("LanguageDetector is not supported.");window.languageDetector||(window.languageDetector=await self.LanguageDetector.create());const{detectedLanguage:n}=(await window.languageDetector.detect(t))[0];return n}async function T(t,n){const e=`${t}-${n}`;return await self.Translator.availability({sourceLanguage:t,targetLanguage:n})==="unavailable"?(console.log(`${t} - ${n} pair is not supported.`),null):(d[e]||(d[e]=await self.Translator.create({sourceLanguage:t,targetLanguage:n})),d[e])}async function E(t,n,e,a){try{if(!("Translator"in self))throw new Error("Translator is not supported.");const r=await T(n,e);if(!r)return"Translation not available for this language pair.";let s="";const o=r.translateStreaming(t);for await(const i of o)s+=i,a&&a(s);return s}catch(r){return console.error("Translation error:",r),"An error occurred. Please try again."}}function w(t){const n=t.tagName==="LI"?"LI":"P",e=document.createElement(n);return e.className="translated",e.style.color="#00695c",e.textContent="...",e}function x(t,n){if(t.tagName==="LI"){const e=t.parentElement;e&&(e.tagName==="UL"||e.tagName==="OL")?e.insertBefore(n,t.nextSibling):t.insertAdjacentElement("afterend",n)}else t.insertAdjacentElement("afterend",n)}function y(t,n){return!v(t,n)&&!C(t,n)?(t.textContent=n,!0):!1}function L(t){return t.closest('pre, code, .highlight, .code-block, [class*="language-"]')!==null}function v(t,n){const e=t.nextElementSibling;return e!==null&&e.classList.contains("translated")&&e.textContent?.trim()===n.trim()}function C(t,n){let e=t.parentElement;for(;e;){const a=e.querySelector(".translated");if(a&&a.textContent?.trim()===n.trim())return!0;e=e.parentElement}return!1}function f(){const t=["article","main",".main-content",'[role="main"]',".content-base"];let n=null;for(const e of t)if(n=document.querySelector(e),n)break;return n?Array.from(n.querySelectorAll(m)).filter(e=>{const a=e.parentElement?.className||"";return!/sidebar|nav|toc/i.test(a)&&e.offsetParent!==null}):[]}function P(t){return(t.textContent?.trim()||"").length>=10&&!L(t)&&!t.closest(".translated")}async function u(t){if(!l||!P(t))return;const n=t.textContent?.trim()||"";if(t.nextElementSibling&&t.nextElementSibling.classList.contains("translated"))return;const a=w(t);x(t,a);try{const r=await b(n);(r==="en"||r==="vi")&&await E(n,r,r==="en"?"vi":"en",o=>y(a,o))}catch(r){console.error("Error processing element:",r),a.textContent="Translation error"}}async function S(){const t=f(),n=5,e=500;for(let a=0;a<t.length&&l;a+=n){const r=t.slice(a,a+n);await Promise.all(r.map(s=>u(s))),console.log(`Translated batch ${a/n+1}/${Math.ceil(t.length/n)}`),a+n<t.length&&await new Promise(s=>setTimeout(s,e))}}function A(){let t=null;const n=()=>{t&&clearTimeout(t),t=setTimeout(async()=>{if(!l)return;const a=f().filter(s=>!s.nextElementSibling?.classList.contains("translated")),r=3;for(let s=0;s<a.length;s+=r){const o=a.slice(s,s+r);await Promise.all(o.map(i=>u(i))),s+r<a.length&&await new Promise(i=>setTimeout(i,300))}},500)},e=new MutationObserver(n);return e.observe(document.body,{childList:!0,subtree:!0}),e}function g(t,n){let e=document.getElementById("translation-progress");e||(e=document.createElement("div"),e.id="translation-progress",e.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 105, 92, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      z-index: 10000;
      font-family: system-ui;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    `,document.body.appendChild(e)),e.innerHTML=`
    Translating: ${t}/${n}
    <button id="cancel-translation" style="margin-left: 10px; cursor: pointer;">Cancel</button>
  `,document.getElementById("cancel-translation")?.addEventListener("click",()=>{l=!1,e&&(e.textContent="Translation cancelled",setTimeout(()=>{e&&e.parentNode&&e.parentNode.removeChild(e)},1500))}),t>=n&&setTimeout(()=>{e&&e.parentNode&&e.parentNode.removeChild(e)},3e3)}function N(){chrome.runtime.onMessage.addListener(async(t,n,e)=>{t.action==="toggleTranslator"&&(l=t.enabled,l&&(document.querySelectorAll(m).length>100?await p():await S()))})}async function p(){const t=f();g(0,t.length);const n=[],e=[];t.forEach(o=>{const i=o.getBoundingClientRect();i.top>=0&&i.top<=window.innerHeight*3?n.push(o):e.push(o)});const a=5,r=300;let s=0;for(let o=0;o<n.length&&l;o+=a){const i=n.slice(o,o+a);await Promise.all(i.map(c=>u(c))),s+=i.length,g(s,t.length),await new Promise(c=>setTimeout(c,r))}for(let o=0;o<e.length&&l;o+=a){const i=e.slice(o,o+a);await Promise.all(i.map(c=>u(c))),s+=i.length,g(s,t.length),await new Promise(c=>setTimeout(c,r*2))}}function I(){const t=new IntersectionObserver(a=>{a.forEach(r=>{if(r.isIntersecting&&l){const s=r.target;s.nextElementSibling?.classList.contains("translated")||u(s),t.unobserve(s)}})},{rootMargin:"200px"});function n(){if(!l)return;f().forEach(r=>{r.nextElementSibling?.classList.contains("translated")||t.observe(r)})}n();let e;return window.addEventListener("scroll",()=>{e&&clearTimeout(e),e=setTimeout(n,500)}),t}function _(){h(),N(),A(),I(),l&&p()}_();
