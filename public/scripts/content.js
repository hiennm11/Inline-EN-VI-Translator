let c=!1;const p={},m="p, h1, h2, h3, h4, h5, h6, span, li, td, th, figcaption, blockquote";function C(){chrome.storage.sync.get("translator_on",e=>{c=e.translator_on||!1})}async function x(e){if(!("LanguageDetector"in self))throw new Error("LanguageDetector is not supported.");window.languageDetector||(window.languageDetector=await self.LanguageDetector.create());const{detectedLanguage:n}=(await window.languageDetector.detect(e))[0];return n}async function L(e,n){const t=`${e}-${n}`;return await self.Translator.availability({sourceLanguage:e,targetLanguage:n})==="unavailable"?(console.log(`${e} - ${n} pair is not supported.`),null):(p[t]||(p[t]=await self.Translator.create({sourceLanguage:e,targetLanguage:n})),p[t])}async function S(e,n,t,o){try{if(!("Translator"in self))throw new Error("Translator is not supported.");const s=await L(n,t);if(!s)return"Translation not available for this language pair.";let a="";const r=s.translateStreaming(e);for await(const i of r)a+=i,o&&o(a);return a}catch(s){return console.error("Translation error:",s),"An error occurred. Please try again."}}function v(e){const n=e.tagName==="LI"?"LI":"P",t=document.createElement(n);return t.className="translated",t.style.color="#00695c",t.textContent="...",t}function A(e,n){if(e.tagName==="LI"){const t=e.parentElement;t&&(t.tagName==="UL"||t.tagName==="OL")?t.insertBefore(n,e.nextSibling):e.insertAdjacentElement("afterend",n)}else e.insertAdjacentElement("afterend",n)}function P(e,n){return!N(e,n)&&!I(e,n)?(e.textContent=n,!0):!1}function b(e){return e.closest('pre, code, .highlight, .code-block, [class*="language-"]')!==null}function N(e,n){const t=e.nextElementSibling;return t!==null&&t.classList.contains("translated")&&t.textContent?.trim()===n.trim()}function I(e,n){let t=e.parentElement;for(;t;){const o=t.querySelector(".translated");if(o&&o.textContent?.trim()===n.trim())return!0;t=t.parentElement}return!1}function D(){const e=Array.from(document.querySelectorAll("div, section, main, article")).filter(t=>{const o=t.tagName.toLowerCase(),s=(t.id||"").toLowerCase(),a=(t.className||"").toString().toLowerCase();return!(/sidebar|nav|header|footer|menu|comment|widget|ad/i.test(s+" "+a)||o==="nav"||o==="header"||o==="footer")});if(e.length===0)return null;const n=e.map(t=>{const o=t.textContent?.length||0,a=t.querySelectorAll(m).length,r=t.querySelectorAll("*").length||1,i=o/r,l=Array.from(t.querySelectorAll("a")).reduce((f,E)=>f+(E.textContent?.length||0),0),u=o>0?l/o:1;let d=0;return d+=o*.1,d+=a*10,d+=i*5,d-=u*50,{element:t,score:d,textLength:o,textDensity:i,paragraphCount:a}}).filter(t=>t.textLength>200&&t.paragraphCount>=2).sort((t,o)=>o.score-t.score);return n.length>0?n[0].element:null}function h(){const e=["article","main",".main-content",'[role="main"]',".content-base",".post-content",".entry-content","#content",".content",".article",".post",".story"];let n=null;for(const t of e){const o=document.querySelectorAll(t);if(o.length>0){if(o.length===1)n=o[0];else{let s=0;o.forEach(a=>{const r=a.textContent?.length||0;r>s&&(s=r,n=a)})}if(n)break}}return n||(n=D()),n||(console.log("No specific content container found, using document body"),n=document.body),Array.from(n.querySelectorAll(m)).filter(t=>{const o=t.parentElement?.className||"",s=(t.id||"").toLowerCase(),a=(t.className||"").toString().toLowerCase(),r=t.offsetParent===null,i=/sidebar|nav|toc|footer|header|menu|comment|widget|ad/i.test(o+" "+a+" "+s),l=(t.textContent?.trim().length||0)>=10;return!r&&!i&&l})}function B(e){return(e.textContent?.trim()||"").length>=10&&!b(e)&&!e.closest(".translated")}function T(){return Array.from(document.querySelectorAll(m)).filter(e=>{const n=(e.className||"").toString().toLowerCase(),t=(e.id||"").toLowerCase(),o=(e.parentElement?.className||"").toString().toLowerCase(),s=e.offsetParent===null,a=/nav|footer|header|sidebar|menu|comment|widget|ad/i.test(n+" "+t+" "+o),r=(e.textContent?.trim().length||0)<10,i=b(e),l=e.closest(".translated")!==null;return!s&&!a&&!r&&!i&&!l})}function k(){const e=T(),n=window.scrollY-300,t=window.scrollY+window.innerHeight+500;return e.filter(o=>{const s=o.getBoundingClientRect(),a=s.top+window.scrollY,r=s.bottom+window.scrollY;return a>=n&&a<=t||r>=n&&r<=t||a<=n&&r>=t})}async function g(e){if(!c||!B(e))return;const n=e.textContent?.trim()||"";if(e.nextElementSibling&&e.nextElementSibling.classList.contains("translated"))return;const o=v(e);A(e,o);try{const s=await x(n);(s==="en"||s==="vi")&&await S(n,s,s==="en"?"vi":"en",r=>P(o,r))}catch(s){console.error("Error processing element:",s),o.textContent="Translation error"}}async function _(){const e=h(),n=5,t=500;for(let o=0;o<e.length&&c;o+=n){const s=e.slice(o,o+n);await Promise.all(s.map(a=>g(a))),console.log(`Translated batch ${o/n+1}/${Math.ceil(e.length/n)}`),o+n<e.length&&await new Promise(a=>setTimeout(a,t))}}function M(){let e=null,n=!1,t=0;const o=a=>{e&&clearTimeout(e),t++,t>10&&(n=!0),e=setTimeout(async()=>{if(!c)return;let r;if(n?r=k():r=h(),r=r.filter(u=>!u.nextElementSibling?.classList.contains("translated")),r.length===0)return;const i=n?2:3,l=n?400:300;for(let u=0;u<r.length;u+=i){const d=r.slice(u,u+i);await Promise.all(d.map(f=>g(f))),u+i<r.length&&await new Promise(f=>setTimeout(f,l))}},n?800:500)},s=new MutationObserver(o);return s.observe(document.body,{childList:!0,subtree:!0,characterData:!1,attributeFilter:["class","style"]}),setInterval(()=>{t=0},3e4),s}function w(e,n){let t=document.getElementById("translation-progress");t||(t=document.createElement("div"),t.id="translation-progress",t.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 105, 92, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      z-index: 10000;
      font-family: system-ui;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    `,document.body.appendChild(t)),t.innerHTML=`
    Translating: ${e}/${n}
    <button id="cancel-translation" style="margin-left: 10px; cursor: pointer;">Cancel</button>
  `,document.getElementById("cancel-translation")?.addEventListener("click",()=>{c=!1,t&&(t.textContent="Translation cancelled",setTimeout(()=>{t&&t.parentNode&&t.parentNode.removeChild(t)},1500))}),e>=n&&setTimeout(()=>{t&&t.parentNode&&t.parentNode.removeChild(t)},3e3)}function q(){chrome.runtime.onMessage.addListener(async(e,n,t)=>{e.action==="toggleTranslator"&&(c=e.enabled,c&&(document.querySelectorAll(m).length>100?await y():await _()))})}async function y(){let e=h();e.length<3&&(console.log("Few paragraphs found in main content, searching across entire page"),e=T()),w(0,e.length);const n=[],t=[];e.forEach(r=>{const i=r.getBoundingClientRect();i.top>=0&&i.top<=window.innerHeight*3?n.push(r):t.push(r)});const o=5,s=300;let a=0;for(let r=0;r<n.length&&c;r+=o){const i=n.slice(r,r+o);await Promise.all(i.map(l=>g(l))),a+=i.length,w(a,e.length),await new Promise(l=>setTimeout(l,s))}for(let r=0;r<t.length&&c;r+=o){const i=t.slice(r,r+o);await Promise.all(i.map(l=>g(l))),a+=i.length,w(a,e.length),await new Promise(l=>setTimeout(l,s*2))}}function H(){const e=new IntersectionObserver(o=>{o.forEach(s=>{if(s.isIntersecting&&c){const a=s.target;a.nextElementSibling?.classList.contains("translated")||g(a),e.unobserve(a)}})},{rootMargin:"200px"});function n(){if(!c)return;h().forEach(s=>{s.nextElementSibling?.classList.contains("translated")||e.observe(s)})}n();let t;return window.addEventListener("scroll",()=>{t&&clearTimeout(t),t=setTimeout(n,500)}),e}function $(){C(),q(),M(),H(),c&&y()}$();
