let u=!1;const C={},b="p, h1, h2, h3, h4, h5, h6, span, li, td, th, figcaption, blockquote";async function S(e){if(!("LanguageDetector"in self))throw new Error("LanguageDetector is not supported.");window.languageDetector||(window.languageDetector=await self.LanguageDetector.create());const{detectedLanguage:n}=(await window.languageDetector.detect(e))[0];return n}async function A(e,n){const t=`${e}-${n}`;return await self.Translator.availability({sourceLanguage:e,targetLanguage:n})==="unavailable"?(console.log(`${e} - ${n} pair is not supported.`),null):(C[t]||(C[t]=await self.Translator.create({sourceLanguage:e,targetLanguage:n})),C[t])}async function N(e,n,t,o){try{if(!("Translator"in self))throw new Error("Translator is not supported.");const r=await A(n,t);if(!r)return"Translation not available for this language pair.";let a="";const s=r.translateStreaming(e);for await(const l of s)a+=l,o&&o(a);return a}catch(r){return console.error("Translation error:",r),"An error occurred. Please try again."}}function P(e){const n=e.tagName==="LI"?"LI":"P",t=document.createElement(n);return t.className="translated",t.style.color="#00695c",t.textContent="...",t}function I(e,n){if(e.tagName==="LI"){const t=e.parentElement;t&&(t.tagName==="UL"||t.tagName==="OL")?t.insertBefore(n,e.nextSibling):e.insertAdjacentElement("afterend",n)}else e.insertAdjacentElement("afterend",n)}function D(e,n){return!B(e,n)&&!k(e,n)?(e.textContent=n,!0):!1}function v(e){return e.closest('pre, code, .highlight, .code-block, [class*="language-"]')!==null}function B(e,n){const t=e.nextElementSibling;return t!==null&&t.classList.contains("translated")&&t.textContent?.trim()===n.trim()}function k(e,n){let t=e.parentElement;for(;t;){const o=t.querySelector(".translated");if(o&&o.textContent?.trim()===n.trim())return!0;t=t.parentElement}return!1}function M(){const e=Array.from(document.querySelectorAll("div, section, main, article")).filter(t=>{const o=t.tagName.toLowerCase(),r=(t.id||"").toLowerCase(),a=(t.className||"").toString().toLowerCase();return!(/sidebar|nav|header|footer|menu|comment|widget|ad/i.test(r+" "+a)||o==="nav"||o==="header"||o==="footer")});if(e.length===0)return null;const n=e.map(t=>{const o=t.textContent?.length||0,a=t.querySelectorAll(b).length,s=t.querySelectorAll("*").length||1,l=o/s,f=Array.from(t.querySelectorAll("a")).reduce((E,g)=>E+(g.textContent?.length||0),0),c=o>0?f/o:1;let d=0;return d+=o*.1,d+=a*10,d+=l*5,d-=c*50,{element:t,score:d,textLength:o,textDensity:l,paragraphCount:a}}).filter(t=>t.textLength>200&&t.paragraphCount>=2).sort((t,o)=>o.score-t.score);return n.length>0?n[0].element:null}function T(){const e=["article","main",".main-content",'[role="main"]',".content-base",".post-content",".entry-content","#content",".content",".article",".post",".story"];let n=null;for(const t of e){const o=document.querySelectorAll(t);if(o.length>0){if(o.length===1)n=o[0];else{let r=0;o.forEach(a=>{const s=a.textContent?.length||0;s>r&&(r=s,n=a)})}if(n)break}}return n||(n=M()),n||(console.log("No specific content container found, using document body"),n=document.body),Array.from(n.querySelectorAll(b)).filter(t=>{const o=t.parentElement?.className||"",r=(t.id||"").toLowerCase(),a=(t.className||"").toString().toLowerCase(),s=t.offsetParent===null,l=/sidebar|nav|toc|footer|header|menu|comment|widget|ad/i.test(o+" "+a+" "+r),f=(t.textContent?.trim().length||0)>=10;return!s&&!l&&f})}function _(e){return(e.textContent?.trim()||"").length>=10&&!v(e)&&!e.closest(".translated")}function L(){return Array.from(document.querySelectorAll(b)).filter(e=>{const n=(e.className||"").toString().toLowerCase(),t=(e.id||"").toLowerCase(),o=(e.parentElement?.className||"").toString().toLowerCase(),r=e.offsetParent===null,a=/nav|footer|header|sidebar|menu|comment|widget|ad/i.test(n+" "+t+" "+o),s=(e.textContent?.trim().length||0)<10,l=v(e),f=e.closest(".translated")!==null;return!r&&!a&&!s&&!l&&!f})}function $(){const e=L(),n=window.scrollY-300,t=window.scrollY+window.innerHeight+500;return e.filter(o=>{const r=o.getBoundingClientRect(),a=r.top+window.scrollY,s=r.bottom+window.scrollY;return a>=n&&a<=t||s>=n&&s<=t||a<=n&&s>=t})}async function p(e){if(!u||!_(e))return;const n=e.textContent?.trim()||"";if(e.nextElementSibling&&e.nextElementSibling.classList.contains("translated"))return;const o=P(e);I(e,o);try{const r=await S(n);(r==="en"||r==="vi")&&await N(n,r,r==="en"?"vi":"en",s=>D(o,s))}catch(r){console.error("Error processing element:",r),o.textContent="Translation error"}}async function q(){h();const e=T();m(0,e.length);const n=5,t=500;for(let o=0;o<e.length&&u;o+=n){const r=e.slice(o,o+n);await Promise.all(r.map(a=>p(a))),m(r.length,0),console.log(`Translated batch ${o/n+1}/${Math.ceil(e.length/n)}`),o+n<e.length&&await new Promise(a=>setTimeout(a,t))}}function H(){let e=null,n=!1,t=0,o=!1,r=0;const a=l=>{e&&clearTimeout(e),t++;let f=!1;for(const c of l){if(c.type==="childList"&&c.addedNodes.length>0){for(const d of c.addedNodes)if(d instanceof HTMLElement&&d.nodeType===Node.ELEMENT_NODE&&d.matches("div, section, article, p, h1, h2, h3, h4, h5, h6")){f=!0,r++;break}}if(f)break}(t>10||r>5)&&(n=!0),f&&(o=!0),e=setTimeout(async()=>{if(!u)return;let c;if(n?c=$():c=T(),c=c.filter(g=>!g.nextElementSibling?.classList.contains("translated")),c.length===0)return;(o&&c.length>3||c.length>8)&&(console.log(`Significant content changes detected, ${c.length} new paragraphs found`),i.isActive||h(),m(0,c.length),o=!1,r=0);const d=n?2:3,E=n?400:300;for(let g=0;g<c.length&&u;g+=d){const x=c.slice(g,g+d);await Promise.all(x.map(y=>p(y))),i.isActive&&m(x.length,0),g+d<c.length&&await new Promise(y=>setTimeout(y,E))}},n?800:500)},s=new MutationObserver(a);return s.observe(document.body,{childList:!0,subtree:!0,characterData:!1,attributeFilter:["class","style"]}),setInterval(()=>{t=0,r=0},3e4),s}let i={current:0,total:0,isActive:!1,timeoutId:null};function m(e,n){i.isActive?(i.current+=e,n>0&&(i.total+=n),i.total<i.current&&(i.total=i.current)):(i.current=e,i.total=n,i.isActive=!0);let t=document.getElementById("translation-progress");t||(t=document.createElement("div"),t.id="translation-progress",t.style.cssText=`
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 105, 92, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      z-index: 10000;
      font-family: system-ui;
      box-shadow: 0 3px 6px rgba(0,0,0,0.16);
    `,document.body.appendChild(t)),t.innerHTML=`
    Translating: ${i.current}/${i.total}
    <button id="cancel-translation" style="margin-left: 10px; cursor: pointer;">Cancel</button>
  `,console.log(`Progress updated: ${i.current}/${i.total}`);const o=document.getElementById("cancel-translation");if(o){const r=o.cloneNode(!0);o.parentNode&&o.parentNode.replaceChild(r,o),r.addEventListener("click",()=>{u=!1,t&&(t.textContent="Translation cancelled",i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=setTimeout(()=>{t&&t.parentNode&&t.parentNode.removeChild(t),h()},1500))})}i.current>=i.total&&(i.timeoutId&&clearTimeout(i.timeoutId),i.timeoutId=setTimeout(()=>{t&&t.parentNode&&t.parentNode.removeChild(t),h()},3e3))}function h(){i={current:0,total:0,isActive:!1,timeoutId:null}}function O(){chrome.runtime.onMessage.addListener(async(e,n,t)=>{e.action==="toggleTranslator"&&(u=e.enabled,u&&(document.querySelectorAll(b).length>100?await w():await q()))})}async function w(){h();let e=T();e.length<3&&(console.log("Few paragraphs found in main content, searching across entire page"),e=L()),m(0,e.length);const n=[],t=[];e.forEach(a=>{const s=a.getBoundingClientRect();s.top>=0&&s.top<=window.innerHeight*3?n.push(a):t.push(a)});const o=5,r=300;for(let a=0;a<n.length&&u;a+=o){const s=n.slice(a,a+o);await Promise.all(s.map(l=>p(l))),m(s.length,0),await new Promise(l=>setTimeout(l,r))}for(let a=0;a<t.length&&u;a+=o){const s=t.slice(a,a+o);await Promise.all(s.map(l=>p(l))),m(s.length,0),await new Promise(l=>setTimeout(l,r*2))}}function Y(){const e=new IntersectionObserver(o=>{o.forEach(r=>{if(r.isIntersecting&&u){const a=r.target;a.nextElementSibling?.classList.contains("translated")||p(a),e.unobserve(a)}})},{rootMargin:"200px"});function n(){if(!u)return;T().forEach(r=>{r.nextElementSibling?.classList.contains("translated")||e.observe(r)})}n();let t;return window.addEventListener("scroll",()=>{t&&clearTimeout(t),t=setTimeout(n,500)}),e}function R(){let e=location.href;new MutationObserver(()=>{if(e!==location.href&&(console.log("URL changed from",e,"to",location.href),e=location.href,u)){console.log("SPA navigation detected, starting translation"),document.querySelectorAll(".translated").forEach(o=>{o.remove()}),h();const t=document.getElementById("translation-progress");t&&t.parentNode&&t.parentNode.removeChild(t),w()}}).observe(document,{subtree:!0,childList:!0})}function V(){chrome.storage.sync.get("translator_on",e=>{u=e.translator_on||!1,O(),H(),Y(),R(),u&&(console.log("Extension is ON, automatically starting translation after page load"),document.readyState==="complete"?w():window.addEventListener("load",()=>{w()}))})}V();
